"""
plot_vulnerability_histogram.py

Histogram of NAFTA vulnerability (scaled) for all CZs vs sample CZs,
with Q1/Q4 quartile markers.

Inputs:
  - data/processed/econ/12_nafta_vars_cz.parquet   (all 713 CZs)
  - data/processed/panel/14_regression_panel.parquet (sample ~99 CZs)

Outputs:
  - output/figures/vulnerability_histogram.pdf
"""

import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from pathlib import Path

BASE_DIR = Path(os.environ["SHIFTING_SLANT_DIR"])
CZ_PATH = BASE_DIR / "data" / "processed" / "econ" / "12_nafta_vars_cz.parquet"
PANEL_PATH = BASE_DIR / "data" / "processed" / "panel" / "14_regression_panel.parquet"
FIG_DIR = BASE_DIR / "output" / "figures"


def main():
    FIG_DIR.mkdir(parents=True, exist_ok=True)

    # All CZs: one row per CZ (use 1990 cross-section)
    cz = pd.read_parquet(CZ_PATH)
    cz90 = cz[cz["year"] == 1990].dropna(subset=["vulnerability1990_scaled"]).copy()
    all_vuln = cz90["vulnerability1990_scaled"].values
    n_all = len(all_vuln)

    # Sample CZs from regression panel
    panel = pd.read_parquet(PANEL_PATH)
    sample_czs = panel.dropna(subset=["vulnerability1990_scaled"])["cz"].unique()
    sample_vuln = cz90[cz90["czone"].isin(sample_czs)]["vulnerability1990_scaled"].values
    n_sample = len(sample_vuln)

    # Quartiles of the full distribution
    q1 = np.percentile(all_vuln, 25)
    q4 = np.percentile(all_vuln, 75)

    print(f"All CZs: N={n_all}, Q1={q1:.3f}, Q4={q4:.3f}")
    print(f"Sample CZs: N={n_sample}")

    # Plot
    fig, ax = plt.subplots(figsize=(10, 5.5))

    bins = np.arange(0, all_vuln.max() + 0.05, 0.05)

    ax.hist(all_vuln, bins=bins, color="#c0c0c0", edgecolor="white",
            linewidth=0.4, label=f"All CZs (N={n_all})", zorder=2)
    ax.hist(sample_vuln, bins=bins, color="#e25a5a", edgecolor="white",
            linewidth=0.4, alpha=0.85, label=f"Sample CZs (N={n_sample})", zorder=3)

    # Q1 / Q4 markers
    ax.axvline(q1, color="black", linewidth=1.0, linestyle="--", zorder=4)
    ax.axvline(q4, color="black", linewidth=1.0, linestyle="--", zorder=4)
    ymax = ax.get_ylim()[1]
    ax.text(q1, ymax * 0.97, "Q1", ha="center", va="top", fontsize=10,
            fontweight="bold", color="#333333")
    ax.text(q4, ymax * 0.97, "Q4", ha="center", va="top", fontsize=10,
            fontweight="bold", color="#333333")

    ax.set_xlabel("NAFTA Vulnerability (scaled)", fontsize=12)
    ax.set_ylabel("Number of Commuting Zones", fontsize=12)
    ax.legend(fontsize=10, framealpha=0.9)

    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)

    fig.tight_layout(pad=0.3)
    out_path = FIG_DIR / "vulnerability_histogram.pdf"
    fig.savefig(out_path, bbox_inches="tight", pad_inches=0.05, facecolor="white")
    plt.close(fig)
    print(f"Saved: {out_path}")


if __name__ == "__main__":
    main()
