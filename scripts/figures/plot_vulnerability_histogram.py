"""
plot_vulnerability_histogram.py

Distribution of NAFTA vulnerability (scaled) for all CZs vs sample CZs.
Two-panel stacked bar chart with shared x-axis. Bar colors follow the
same sequential palette as the choropleth map (Figure 1).

Inputs:
  - data/processed/econ/12_nafta_vars_cz.parquet   (all 713 CZs)
  - data/processed/runs/exp_shvocab_cv/panel/14_regression_panel.parquet

Outputs:
  - output/figures/vulnerability_histogram.pdf/.png
"""

import os
import sys
import numpy as np
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
from pathlib import Path

# LaTeX-style fonts
matplotlib.rcParams.update({
    "font.family": "serif",
    "font.serif": ["Computer Modern Roman", "CMU Serif", "Times New Roman"],
    "mathtext.fontset": "cm",
    "text.usetex": False,
    "axes.labelsize": 12,
    "xtick.labelsize": 10,
    "ytick.labelsize": 10,
})

BASE_DIR = Path(os.environ["SHIFTING_SLANT_DIR"])
sys.path.insert(0, str(BASE_DIR / "scripts" / "nlp"))
import pipeline_config as cfg

CZ_PATH = BASE_DIR / "data" / "processed" / "econ" / "12_nafta_vars_cz.parquet"
PANEL_PATH = cfg.PANEL_DIR / "14_regression_panel.parquet"
FIG_DIR = BASE_DIR / "output" / "figures"

# Same sequential palette as the choropleth map (Figure 1)
MAP_COLORS = ["#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000", "#7f0000"]


def main():
    FIG_DIR.mkdir(parents=True, exist_ok=True)

    # All CZs: one row per CZ (use 1990 cross-section)
    cz = pd.read_parquet(CZ_PATH)
    cz90 = cz[cz["year"] == 1990].dropna(subset=["vulnerability1990_scaled"]).copy()
    all_vuln = cz90["vulnerability1990_scaled"].values
    n_all = len(all_vuln)

    # Sample CZs from regression panel
    panel = pd.read_parquet(PANEL_PATH)
    sample_czs = panel.dropna(subset=["vulnerability1990_scaled"])["cz"].unique()
    sample_vuln = cz90[cz90["czone"].isin(sample_czs)]["vulnerability1990_scaled"].values
    n_sample = len(sample_vuln)

    # Quartiles of the full distribution
    q1 = np.percentile(all_vuln, 25)
    q3 = np.percentile(all_vuln, 75)

    print(f"All CZs: N={n_all}, Q1={q1:.3f}, Q3={q3:.3f}")
    print(f"Sample CZs: N={n_sample}")

    bins = np.arange(0, min(all_vuln.max() + 0.05, 2.5), 0.04)

    # Use the same sextile (6-quantile) bins as the choropleth map (Figure 1)
    sextile_edges = list(np.quantile(all_vuln, np.linspace(0, 1, 7)))
    sextile_edges[0] = 0.0  # ensure lower bound is 0
    cmap = mcolors.ListedColormap(MAP_COLORS)
    norm = mcolors.BoundaryNorm(sextile_edges, cmap.N)

    C_Q_LINE = "#4a4a4a"

    # Two-panel figure, shared x-axis
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(7, 5.5), sharex=True,
                                    gridspec_kw={"hspace": 0.08})

    # Weights for share version
    wt_all = np.ones_like(all_vuln) / len(all_vuln)
    wt_sample = np.ones_like(sample_vuln) / len(sample_vuln)

    # Plot histograms and color bars by bin center
    for ax, data, weights, label in [
        (ax1, all_vuln, wt_all, f"All CZs ($N = {n_all}$)"),
        (ax2, sample_vuln, wt_sample, f"Sample CZs ($N = {n_sample}$)"),
    ]:
        _, _, patches = ax.hist(data, bins=bins, weights=weights,
                                color="gray", edgecolor="white",
                                linewidth=0.3, zorder=2)
        # Color each bar by its bin center
        for patch, left_edge, right_edge in zip(patches, bins[:-1], bins[1:]):
            center = (left_edge + right_edge) / 2
            patch.set_facecolor(cmap(norm(center)))
            patch.set_edgecolor("white")

        ax.text(0.97, 0.88, label, transform=ax.transAxes,
                ha="right", va="top", fontsize=10)
        ax.set_ylabel("Share")

    ax2.set_xlabel("NAFTA Vulnerability (scaled)")

    # Q1 / Q3 lines + IQR shading on both panels
    for ax in [ax1, ax2]:
        ax.axvspan(q1, q3, color="#f5f5f5", alpha=0.5, zorder=0)
        for qval in [q1, q3]:
            ax.axvline(qval, color=C_Q_LINE, linewidth=0.9, linestyle="--", zorder=4)
        ax.spines["top"].set_visible(False)
        ax.spines["right"].set_visible(False)
        ax.spines["left"].set_linewidth(0.6)
        ax.spines["bottom"].set_linewidth(0.6)
        ax.tick_params(width=0.6)

    # Q labels only on top panel
    ymax1 = ax1.get_ylim()[1]
    for qval, qlabel in [(q1, "$Q_1$"), (q3, "$Q_3$")]:
        ax1.text(qval, ymax1 * 0.96, qlabel, ha="center", va="top", fontsize=10,
                 color="#333333")

    # Match y-axis scale
    ymax = max(ax1.get_ylim()[1], ax2.get_ylim()[1])
    ax1.set_ylim(0, ymax)
    ax2.set_ylim(0, ymax)

    fig.subplots_adjust(hspace=0.08)
    for ext in ["pdf", "png"]:
        out = FIG_DIR / f"vulnerability_histogram.{ext}"
        fig.savefig(out, dpi=300, bbox_inches="tight", pad_inches=0.05, facecolor="white")
        print(f"  Saved: {out}")
    plt.close(fig)


if __name__ == "__main__":
    main()
