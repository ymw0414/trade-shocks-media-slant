"""
plot_binscatter_vulnerability.py

Binscatter of NAFTA vulnerability vs. change in newspaper slant (post - pre),
after removing division-level common trends.

This figure visualizes the identifying variation in the DiD specification:
within-division, cross-sectional correlation between NAFTA exposure and
the shift in media slant after NAFTA implementation.

Inputs:
  - data/processed/runs/{RUN}/panel/14_regression_panel.parquet

Outputs:
  - output/figures/binscatter_vulnerability.pdf/.png
"""

import os
import sys
import numpy as np
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt
from scipy import stats
from pathlib import Path

matplotlib.rcParams.update({
    "font.family": "serif",
    "font.serif": ["Computer Modern Roman", "CMU Serif", "Times New Roman"],
    "mathtext.fontset": "cm",
    "text.usetex": False,
    "axes.labelsize": 12,
    "xtick.labelsize": 10,
    "ytick.labelsize": 10,
})

BASE_DIR = Path(os.environ["SHIFTING_SLANT_DIR"])
sys.path.insert(0, str(BASE_DIR / "scripts" / "nlp"))
import pipeline_config as cfg

PANEL_PATH = cfg.PANEL_DIR / "14_regression_panel.parquet"
FIG_DIR = BASE_DIR / "output" / "figures"

NAFTA_YEAR = 1994
END_YEAR = 2004
N_BINS = 10

# State FIPS -> Census Division
STATE_TO_DIVISION = {
    9: 1, 23: 1, 25: 1, 33: 1, 44: 1, 50: 1,
    34: 2, 36: 2, 42: 2,
    17: 3, 18: 3, 26: 3, 39: 3, 55: 3,
    19: 4, 20: 4, 27: 4, 29: 4, 31: 4, 38: 4, 46: 4,
    10: 5, 11: 5, 12: 5, 13: 5, 24: 5, 37: 5, 45: 5, 51: 5, 54: 5,
    1: 6, 21: 6, 28: 6, 47: 6,
    5: 7, 22: 7, 40: 7, 48: 7,
    4: 8, 8: 8, 16: 8, 30: 8, 32: 8, 35: 8, 49: 8, 56: 8,
    2: 9, 6: 9, 15: 9, 41: 9, 53: 9,
}


def make_binscatter(newspaper_df, xcol, ycol, n_bins, ax, color="#333333"):
    """Create binscatter: bin x into equal-sized groups, plot mean y in each bin."""
    df = newspaper_df[[xcol, ycol]].dropna().copy()

    # Assign bins by quantile (equal count)
    df["bin"] = pd.qcut(df[xcol], n_bins, labels=False, duplicates="drop")
    binned = df.groupby("bin").agg(
        x_mean=(xcol, "mean"),
        y_mean=(ycol, "mean"),
        n=("bin", "size"),
    ).reset_index()

    # Plot binned means
    ax.scatter(binned["x_mean"], binned["y_mean"], color=color, s=50, zorder=5,
               edgecolors="white", linewidths=0.5)

    # OLS fit line on the underlying (unbinned) data
    slope, intercept, r, p, se = stats.linregress(df[xcol], df[ycol])
    x_range = np.linspace(df[xcol].min(), df[xcol].max(), 100)
    ax.plot(x_range, intercept + slope * x_range, color=color, linewidth=1.2,
            linestyle="-", alpha=0.7, zorder=4)

    return slope, se, p, len(df)


def main():
    FIG_DIR.mkdir(parents=True, exist_ok=True)

    # Load panel
    df = pd.read_parquet(PANEL_PATH)
    df = df[df["cz"].notna() & df["vulnerability1990_scaled"].notna()].copy()
    df = df[df["year"] <= END_YEAR].copy()

    df["state_fips"] = (df["fips"] // 1000).astype(int)
    df["division"] = df["state_fips"].map(STATE_TO_DIVISION)
    df["post"] = (df["year"] >= NAFTA_YEAR).astype(int)

    print(f"Panel: {len(df):,} obs, {df['paper'].nunique()} papers, "
          f"{df['cz'].nunique()} CZs")

    # --- Compute newspaper-level post-pre changes ---
    outcomes = {
        "net_slant_norm": r"$\Delta$ Net Slant (normalized)",
        "ext_R": r"$\Delta$ Share R-Leaning Articles",
    }

    # For each newspaper: mean(y|post) - mean(y|pre)
    nws = []
    for paper in df["paper"].unique():
        pdata = df[df["paper"] == paper]
        row = {
            "paper": paper,
            "vulnerability": pdata["vulnerability1990_scaled"].iloc[0],
            "cz": pdata["cz"].iloc[0],
            "division": pdata["division"].iloc[0],
        }
        for yvar in outcomes:
            pre = pdata.loc[pdata["post"] == 0, yvar].mean()
            post = pdata.loc[pdata["post"] == 1, yvar].mean()
            row[f"d_{yvar}"] = post - pre
        nws.append(row)

    nw_df = pd.DataFrame(nws)
    print(f"Newspapers: {len(nw_df)}")

    # Residualize by division (remove division-level common changes)
    for yvar in outcomes:
        col = f"d_{yvar}"
        div_means = nw_df.groupby("division")[col].transform("mean")
        nw_df[f"r_{yvar}"] = nw_df[col] - div_means

    # --- Figure: 2-panel binscatter ---
    fig, axes = plt.subplots(1, 2, figsize=(11, 4.5))

    panels = [
        ("net_slant_norm", r"$\Delta$ Net Slant (normalized)", "(a)"),
        ("ext_R", r"$\Delta$ Share R-Leaning", "(b)"),
    ]

    for ax, (yvar, ylabel, panel_label) in zip(axes, panels):
        resid_col = f"r_{yvar}"

        slope, se, p, n = make_binscatter(
            nw_df, "vulnerability", resid_col, N_BINS, ax
        )

        stars = "***" if p < 0.01 else "**" if p < 0.05 else "*" if p < 0.1 else ""
        print(f"  {yvar}: slope={slope:.4f} (SE={se:.4f}), p={p:.4f}{stars}, N={n}")

        ax.axhline(0, color="gray", linewidth=0.5, linestyle="-", zorder=1)
        ax.set_xlabel("NAFTA Vulnerability (scaled)")
        ax.set_ylabel(ylabel)
        ax.set_title(panel_label, fontsize=11, loc="left", fontweight="bold")

        # Annotation: slope and significance
        ax.annotate(
            f"slope = {slope:.3f}{stars}\n(SE = {se:.3f})",
            xy=(0.97, 0.05), xycoords="axes fraction",
            ha="right", va="bottom", fontsize=9,
            bbox=dict(boxstyle="round,pad=0.3", facecolor="white",
                      edgecolor="#cccccc", alpha=0.9),
        )

        ax.spines["top"].set_visible(False)
        ax.spines["right"].set_visible(False)
        ax.spines["left"].set_linewidth(0.6)
        ax.spines["bottom"].set_linewidth(0.6)
        ax.tick_params(width=0.6)

    fig.tight_layout(w_pad=3, pad=0.5)
    for ext in ["pdf", "png"]:
        out = FIG_DIR / f"binscatter_vulnerability.{ext}"
        fig.savefig(out, dpi=300, bbox_inches="tight", pad_inches=0.05,
                    facecolor="white")
        print(f"  Saved: {out}")
    plt.close(fig)

    # --- Also make single-panel version (Share R-Leaning) ---
    fig, ax = plt.subplots(figsize=(6, 4.5))
    slope, se, p, n = make_binscatter(
        nw_df, "vulnerability", "r_ext_R", N_BINS, ax
    )
    stars = "***" if p < 0.01 else "**" if p < 0.05 else "*" if p < 0.1 else ""

    ax.axhline(0, color="gray", linewidth=0.5, linestyle="-", zorder=1)
    ax.set_xlabel("NAFTA Vulnerability (scaled)")
    ax.set_ylabel(r"$\Delta$ Share R-Leaning (residualized)")
    ax.annotate(
        f"slope = {slope:.3f}{stars}\n(SE = {se:.3f})",
        xy=(0.97, 0.05), xycoords="axes fraction",
        ha="right", va="bottom", fontsize=9,
        bbox=dict(boxstyle="round,pad=0.3", facecolor="white",
                  edgecolor="#cccccc", alpha=0.9),
    )
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)
    ax.spines["left"].set_linewidth(0.6)
    ax.spines["bottom"].set_linewidth(0.6)
    ax.tick_params(width=0.6)

    fig.tight_layout(pad=0.5)
    for ext in ["pdf", "png"]:
        out = FIG_DIR / f"binscatter_vulnerability_single.{ext}"
        fig.savefig(out, dpi=300, bbox_inches="tight", pad_inches=0.05,
                    facecolor="white")
        print(f"  Saved: {out}")
    plt.close(fig)


if __name__ == "__main__":
    main()
